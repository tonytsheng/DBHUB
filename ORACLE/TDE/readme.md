## TDE on self managed Oracle - use this to prove out some other stuff

## Set up sqlnet.ora
- Add this to $ORACLE_HOME/network/admin/sqlnet.ora
```
ENCRYPTION_WALLET_LOCATION=(SOURCE=(METHOD=FILE)(METHOD_DATA=(DIRECTORY=/data/oracle/admin/prod9/wallet)) )
```

## Database
- Create keystore
```
SQL> ADMINISTER KEY MANAGEMENT CREATE KEYSTORE '/u01/app/oracle/admin/oradev/wallet' IDENTIFIED BY "Pass";

keystore altered.

SQL> HOST ls -ls /u01/app/oracle/admin/oradev/wallet
total 4
4 -rw------- 1 oracle oinstall 2408 Nov  6 14:01 ewallet.p12
```
- Open Keystore
```
SQL> ADMINISTER KEY MANAGEMENT SET KEYSTORE OPEN IDENTIFIED BY "Pass";

keystore altered.

SQL> SELECT con_id, key_id FROM v$encryption_keys;

no rows selected
```
- Set Key
```
SQL> ADMINISTER KEY MANAGEMENT SET KEY IDENTIFIED BY "Pass" WITH BACKUP;

keystore altered.

SQL> SELECT con_id, key_id FROM v$encryption_keys;

    CON_ID
----------
KEY_ID
------------------------------------------------------------------------------
         0
AdAI4ksPz0//v5j6Cjf8ZQ0AAAAAAAAAAAAAAAAAAAAAAAAAAAAA


SQL> select * from v$encryption_wallet;

WRL_TYPE
--------------------
WRL_PARAMETER
--------------------------------------------------------------------------------
STATUS                         WALLET_TYPE          WALLET_OR FULLY_BAC
------------------------------ -------------------- --------- ---------
    CON_ID
----------
FILE
/u01/app/oracle/admin/oradev/wallet/
OPEN                           PASSWORD             SINGLE    NO
         0
```
- Set Auto Login
```
SQL> ADMINISTER KEY MANAGEMENT CREATE AUTO_LOGIN KEYSTORE FROM KEYSTORE '/u01/app/oracle/admin/oradev/wallet' IDENTIFIED BY "Pass";

keystore altered.

SQL> select * from v$encryption_wallet;

WRL_TYPE
--------------------
WRL_PARAMETER
--------------------------------------------------------------------------------
STATUS                         WALLET_TYPE          WALLET_OR FULLY_BAC
------------------------------ -------------------- --------- ---------
    CON_ID
----------
FILE
/u01/app/oracle/admin/oradev/wallet/
OPEN                           PASSWORD             SINGLE    NO
         0


SQL> HOST ls -ls /u01/app/oracle/admin/oradev/wallet
total 12
4 -rw------- 1 oracle oinstall 3891 Nov  6 14:02 cwallet.sso
4 -rw------- 1 oracle oinstall 2408 Nov  6 14:02 ewallet_2023110614022027.p12
4 -rw------- 1 oracle oinstall 3848 Nov  6 14:02 ewallet.p12
```
- Create encrypted tablespace
```
SQL> create tablespace customer_orders_enc
datafile '/u01/app/oracle/oradata/oradev/customer_orders_enc.dbf'
size 100M autoextend on maxsize 1G extent management
local segment
space management
auto encryption default storage (encrypt);
  2    3    4    5    6

Tablespace created.

SQL> select tablespace_name, encrypted from dba_tablespaces;

TABLESPACE_NAME                ENC
------------------------------ ---
SYSTEM                         NO
SYSAUX                         NO
UNDOTBS1                       NO
TEMP                           NO
USERS                          NO
CUSTOMER_ORDERS_ENC            YES

6 rows selected.
```
- Restart database
```
SQL> shutdown immediate;
Database closed.
Database dismounted.
ORACLE instance shut down.
SQL> startup
ORACLE instance started.

Total System Global Area 2147483648 bytes
Fixed Size                  8622776 bytes
Variable Size             721423688 bytes
Database Buffers         1409286144 bytes
Redo Buffers                8151040 bytes
Database mounted.
Database opened.
SQL> select * from v$encryption_wallet;

WRL_TYPE
--------------------
WRL_PARAMETER
--------------------------------------------------------------------------------
STATUS                         WALLET_TYPE          WALLET_OR FULLY_BAC
------------------------------ -------------------- --------- ---------
    CON_ID
----------
FILE
/u01/app/oracle/admin/oradev/wallet/
OPEN                           AUTOLOGIN            SINGLE    NO
         0

```
- Login as application owner and create table with encryption
```
SQL> conn customer_orders/Pass
Connected.
SQL> create table orders (
  order_id        integer
                  generated by default on null as identity,
  order_datetime  timestamp not null,
  customer_id     integer not null,
  order_status    varchar2(10 char) not null,
  store_id        integer not null,
  order_img       blob encrypt) -- encrypt for dms test
tablespace customer_orders_enc
;
```

