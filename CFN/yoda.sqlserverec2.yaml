AWSTemplateFormatVersion: 2010-09-09
Description: Yoda build Sqlserver DB on EC2 from AMI

Parameters:
  WindowsAmiId:
    Type: AWS::EC2::Image::Id
    # Default: /aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2
    # Default: YoDA_SQLServer_v2
    Default: ami-070411e630b34480c 
  KeyPairName:
    ConstraintDescription: must be the name of an existing EC2 KeyPair.
    Description: Name of an existing EC2 KeyPair to enable SSH access to the instance
    Type: AWS::EC2::KeyPair::KeyName 
  SqlserverInstanceType:
    AllowedValues:
      - t3.xlarge
      - m5.xlarge
      - r5.xlarge
    ConstraintDescription: Must be a valid EC2 instance type.
    Default: t3.xlarge
    Description: Choose your Sqlserver Database instance type.
    Type: String
  VPCID:
    Description: ID of the VPC (e.g., vpc-9abec3e0)
    Type: AWS::EC2::VPC::Id
  LaptopIp: 
    Type: String
    Description: My laptop ip address

Resources:

  ec2SqlserverSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: ec2Sqlserver Security Group
      GroupDescription: Enable RDP (port 3389) and Sqlserver Database (port 1433) to ec2Server
      VpcId: !Ref VPCID
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 3389
          ToPort: 3389
          CidrIp: !Sub '${LaptopIp}/32'
        - IpProtocol: tcp
          FromPort: 1433
          ToPort: 1433
          CidrIp: !Sub '${LaptopIp}/32'

  ec2Server:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !Ref WindowsAmiId
      InstanceType: !Ref SqlserverInstanceType
      KeyName: !Ref KeyPairName 
      SecurityGroupIds:
        - !Ref ec2SqlserverSecurityGroup
      Tags: 
        # - Key: Owner
        #   Value: !Ref "AWS::AccountId"
        - Key: Name
          Value: "migration-lab-sql"     

   
Outputs:
  Region:
    Value: !Ref AWS::Region
    Description: ec2 Server Region
  EC2InstanceID:
    Value: !Ref ec2Server
    Description: The EC2 Instance ID 

